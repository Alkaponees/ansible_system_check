---
- name: System Health Check
  hosts: servers
  gather_facts: yes

  vars:
    report_path: "/tmp/system_report.json"
    html_report_path: "/var/www/html/system-reports/reports/system_report_{{ inventory_hostname }}_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}{{ ansible_date_time.second }}.html"

  roles:
    - system_check

  tasks:
    - name: Print location of report
      debug:
        msg: "System report saved to {{ report_path }}"

    - name: Ensure backup directory exists
      file:
        path: "{{ backup_local_dir }}"
        state: directory
        mode: "0755"

    - name: Show DB type selected for restore testing
      debug:
        msg: "Selected DB type for restore test: {{ db_type }}"

    - name: Skip backup test if DB_TYPE=none
      debug:
        msg: "Backup restore test is disabled (DB_TYPE=none)"
      when: db_type == "none"

    - name: Run MongoDB backup restore test
      include_role:
        name: restore_mongo
      when: db_type == "mongo"

    - name: Run MySQL backup restore test
      include_role:
        name: restore_mysql
      when: db_type == "mysql"

    - name: Run PostgreSQL backup restore test
      include_role:
        name: restore_pg
      when: db_type == "postgres"
